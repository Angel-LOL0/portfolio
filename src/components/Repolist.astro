---
import type { GitHubRepository } from "types/github";
import { FileX, Pin, Star, Rocket } from "@lucide/astro";
import RepoCard from "components/RepoCard.astro";

const { request } = Astro;
const baseUrl = new URL(request.url).origin;

let pinnedRepos: GitHubRepository[] = [];
let popularRepos: GitHubRepository[] = [];
let createdRepos: GitHubRepository[] = [];

try {
  const [pinned, popular, created] = await Promise.all([
    fetch(`${baseUrl}/api/github/pinned.json`).then((r) => r.json()),
    fetch(`${baseUrl}/api/github/popular.json`).then((r) => r.json()),
    fetch(`${baseUrl}/api/github/created.json`).then((r) => r.json()),
  ]);

  pinnedRepos = pinned;
  popularRepos = popular;
  createdRepos = created;
} catch (error) {
  console.error("Error cargando repos:", error);
}
---

<div class="bg-latte-base dark:bg-mocha-base min-h-screen">
  <!-- Sección: Repositorios Importantes (Pinneados) -->
  {
    pinnedRepos.length > 0 && (
      <section id="pinned-projects" class="max-w-6xl mx-auto px-4 py-20">
        <div class="text-center mb-12">
          <div class="flex gap-0.5 md:gap-2 justify-center mb-4">
            <Pin class="transition size-20 md:size-16 text-latte-blue dark:text-mocha-blue" />
            <h2 class="text-4xl md:text-5xl font-bold text-latte-text dark:text-mocha-text">
              Repositorios Importantes
            </h2>
          </div>
          <p class="text-lg text-latte-subtext0 dark:text-mocha-subtext0">
            Proyectos seleccionados personalmente
          </p>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {pinnedRepos.map((repo: any) => (
            <RepoCard repo={repo} showStats={true} />
          ))}
        </div>
      </section>
    )
  }

  <!-- Sección: Repositorios Destacados (Por Estrellas) -->
  {
    popularRepos.length > 0 && (
      <section id="popular-projects" class="max-w-6xl mx-auto px-4 py-20">
        <div class="text-center mb-12">
          <div class="flex gap-2 justify-center">
            <>
              <Star class="transition size-9 md:size-16 text-latte-yellow dark:text-mocha-yellow" />
              <h2 class="text-4xl md:text-5xl font-bold mb-4 text-latte-text dark:text-mocha-text">
                Repositorios Destacados
              </h2>
            </>
          </div>
          <p class="text-lg text-latte-subtext0 dark:text-mocha-subtext0">
            Mis proyectos más populares en GitHub
          </p>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {popularRepos.map((repo: any) => (
            <RepoCard repo={repo} showStats={true} />
          ))}
        </div>
      </section>
    )
  }

  <!-- Sección: Repositorios Recientes -->
  {
    createdRepos.length > 0 && (
      <section id="recent-projects" class="max-w-6xl mx-auto px-4 py-20">
        <div class="text-center mb-12">
          <div class="flex gap-2 justify-center">
            <Rocket class="transition size-9 md:size-16 text-latte-red dark:text-mocha-red" />
            <h2 class="text-4xl md:text-5xl font-bold mb-4 text-latte-text dark:text-mocha-text">
              Repositorios Recientes
            </h2>
          </div>
          <p class="text-lg text-latte-subtext0 dark:text-mocha-subtext0">
            Mis proyectos más recientes en GitHub
          </p>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {createdRepos.map((repo: any) => (
            <RepoCard repo={repo} showStats={true} />
          ))}
        </div>
      </section>
    )
  }

  <!-- Mensaje si no hay repos -->
  {
    pinnedRepos.length === 0 &&
      popularRepos.length === 0 &&
      createdRepos.length === 0 && (
        <div class="max-w-6xl mx-auto px-4 py-20">
          <div class="text-center py-20 bg-latte-mantle/50 dark:bg-mocha-mantle/50 rounded-3xl border border-latte-surface0 dark:border-mocha-surface0">
            <FileX class="w-16 h-16 mx-auto mb-4 text-latte-overlay0 dark:text-mocha-overlay0" />

            <h3 class="text-2xl font-bold text-latte-text dark:text-mocha-text mb-2">
              No se encontraron repositorios
            </h3>

            {import.meta.env.DEV ? (
              <p class="text-lg text-latte-subtext0 dark:text-mocha-subtext0">
                Asegúrate de tener repositorios públicos en tu cuenta de GitHub
              </p>
            ) : (
              <p class="text-lg text-latte-subtext0 dark:text-mocha-subtext0">
                Los proyectos estarán disponibles próximamente
              </p>
            )}
          </div>
        </div>
      )
  }
</div>

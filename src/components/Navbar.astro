---
import { Sun, Moon, Monitor, Menu, X } from "@lucide/astro";
---

<nav
  class="fixed top-0 w-full z-50 bg-latte-base/80 dark:bg-mocha-base/80 backdrop-blur-lg border-b border-latte-surface0 dark:border-mocha-surface0"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo / Nombre -->
      <a href="/" class="flex items-center gap-2 group">
        <div
          class="w-10 h-10 rounded-full bg-linear-to-br from-latte-blue to-latte-mauve dark:from-mocha-blue dark:to-mocha-mauve flex items-center justify-center font-bold text-white group-hover:scale-110 transition-transform"
        >
          AS
        </div>
        <span
          class="font-bold text-xl text-latte-text dark:text-mocha-text hidden sm:block"
        >
          Angel Salvador
        </span>
      </a>

      <!-- Links de navegación -->
      <div class="hidden md:flex items-center gap-8">
        <a
          href="#about"
          class="text-latte-text dark:text-mocha-text hover:text-latte-blue dark:hover:text-mocha-blue transition font-medium"
        >
          Sobre mí
        </a>
        <a
          href="#pinned-projects"
          class="text-latte-text dark:text-mocha-text hover:text-latte-blue dark:hover:text-mocha-blue transition font-medium"
        >
          Proyectos
        </a>
        <a
          href="#contact"
          class="text-latte-text dark:text-mocha-text hover:text-latte-blue dark:hover:text-mocha-blue transition font-medium"
        >
          Contacto
        </a>
      </div>

      <!-- Theme Switcher + Mobile Menu -->
      <div class="flex items-center gap-4">
        <!-- Theme Switcher -->
        <div class="relative" id="theme-switcher">
          <button
            id="theme-button"
            class="p-2 rounded-lg bg-latte-surface0 dark:bg-mocha-surface0 text-latte-text dark:text-mocha-text hover:bg-latte-surface1 dark:hover:bg-mocha-surface1 transition"
            aria-label="Cambiar tema"
          >
            <Sun id="theme-icon-light" class="w-5 h-5 hidden" />
            <Moon id="theme-icon-dark" class="w-5 h-5 hidden" />
            <Monitor id="theme-icon-system" class="w-5 h-5 hidden" />
          </button>

          <!-- Dropdown Menu -->
          <div
            id="theme-menu"
            class="absolute right-0 mt-2 w-48 rounded-xl bg-latte-base dark:bg-mocha-base border border-latte-surface0 dark:border-mocha-surface0 shadow-lg hidden"
          >
            <button
              data-theme="light"
              class="w-full px-4 py-3 text-left hover:bg-latte-surface0 dark:hover:bg-mocha-surface0 transition flex items-center gap-3 rounded-t-xl text-latte-text dark:text-mocha-text"
            >
              <Sun class="w-5 h-5" />
              <span>Claro</span>
            </button>
            <button
              data-theme="dark"
              class="w-full px-4 py-3 text-left hover:bg-latte-surface0 dark:hover:bg-mocha-surface0 transition flex items-center gap-3 text-latte-text dark:text-mocha-text"
            >
              <Moon class="w-5 h-5" />
              <span>Oscuro</span>
            </button>
            <button
              data-theme="system"
              class="w-full px-4 py-3 text-left hover:bg-latte-surface0 dark:hover:bg-mocha-surface0 transition flex items-center gap-3 rounded-b-xl text-latte-text dark:text-mocha-text"
            >
              <Monitor class="w-5 h-5" />
              <span>Sistema</span>
            </button>
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-button"
          class="md:hidden p-2 rounded-lg bg-latte-surface0 dark:bg-mocha-surface0 text-latte-text dark:text-mocha-text"
          aria-label="Menu"
        >
          <Menu id="menu-icon-open" class="w-6 h-6" />
          <X id="menu-icon-close" class="w-6 h-6 hidden" />
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden border-t border-latte-surface0 dark:border-mocha-surface0"
  >
    <div class="px-4 py-4 space-y-3">
      <a
        href="#about"
        class="block px-4 py-2 rounded-lg text-latte-text dark:text-mocha-text hover:bg-latte-surface0 dark:hover:bg-mocha-surface0 transition"
      >
        Sobre mí
      </a>
      <a
        href="#pinned-projects"
        class="block px-4 py-2 rounded-lg text-latte-text dark:text-mocha-text hover:bg-latte-surface0 dark:hover:bg-mocha-surface0 transition"
      >
        Proyectos
      </a>
      <a
        href="#contact"
        class="block px-4 py-2 rounded-lg text-latte-text dark:text-mocha-text hover:bg-latte-surface0 dark:hover:bg-mocha-surface0 transition"
      >
        Contacto
      </a>
    </div>
  </div>
</nav>

<script is:inline>
  // Ejecutar antes de que se renderice la página para evitar flash
  const getThemePreference = () => {
    if (typeof localStorage !== "undefined") {
      const stored = localStorage.getItem("theme");
      if (stored) return stored;
    }
    return "system";
  };

  const getSystemTheme = () => {
    return window.matchMedia("(prefers-color-scheme: dark)").matches
      ? "dark"
      : "light";
  };

  const applyTheme = (theme) => {
    let actualTheme = theme;
    if (theme === "system") {
      actualTheme = getSystemTheme();
    }

    if (actualTheme === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  };

  // Aplicar tema inmediatamente
  const theme = getThemePreference();
  applyTheme(theme);

  // Escuchar cambios en el sistema
  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", (e) => {
      const currentTheme = getThemePreference();
      if (currentTheme === "system") {
        applyTheme("system");
      }
    });

  // Función global para cambiar tema
  window.setTheme = (newTheme) => {
    localStorage.setItem("theme", newTheme);
    applyTheme(newTheme);

    // Disparar evento personalizado
    window.dispatchEvent(new CustomEvent("themechange", { detail: newTheme }));
  };

  // Función global para obtener tema actual
  window.getTheme = () => {
    return getThemePreference();
  };

  // Theme Switcher Logic
  const themeButton = document.getElementById("theme-button");
  const themeMenu = document.getElementById("theme-menu");
  const themeButtons = document.querySelectorAll("[data-theme]");
  const icons = {
    light: document.getElementById("theme-icon-light"),
    dark: document.getElementById("theme-icon-dark"),
    system: document.getElementById("theme-icon-system"),
  };

  const updateIcon = () => {
    const currentTheme = window.getTheme();
    Object.values(icons).forEach((icon) => icon?.classList.add("hidden"));
    icons[currentTheme]?.classList.remove("hidden");
  };

  themeButton?.addEventListener("click", () => {
    themeMenu?.classList.toggle("hidden");
  });

  themeButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const theme = button.getAttribute("data-theme");
      if (theme) {
        window.setTheme(theme);
        updateIcon();
        themeMenu?.classList.add("hidden");
      }
    });
  });

  // Cerrar menu al hacer click fuera
  document.addEventListener("click", (e) => {
    if (!themeButton?.contains(e.target) && !themeMenu?.contains(e.target)) {
      themeMenu?.classList.add("hidden");
    }
  });

  // Mobile Menu Logic
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIconOpen = document.getElementById("menu-icon-open");
  const menuIconClose = document.getElementById("menu-icon-close");

  mobileMenuButton?.addEventListener("click", () => {
    mobileMenu?.classList.toggle("hidden");
    menuIconOpen?.classList.toggle("hidden");
    menuIconClose?.classList.toggle("hidden");
  });

  // Actualizar icono al cargar
  updateIcon();
  window.addEventListener("themechange", updateIcon);
</script>
